---
title: "Analysebok for NoRGast"
author: "Kevin Thon"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  \VignetteEncoding{UTF-8}
---

R-pakken _norgast_ er en samling funksjoner og filer for Norsk register for gastrokirurgi.

Dette dokumentet skal dokumentere funksjonene og alt annet som er relevant for pakken. Der man potensielt kan definere ting på ulike måter, skal man i dette dokumentet finne en forklaring på hva som er gjort. Når f.eks. konfidensintevaller inkluderes i en figur så skal man i analysenboken finne hvilke antagelser som ligger til grunn for beregningene. Variabler med deres tillatte verdier skal også dokumenteres her.

## Registerets oppbygging og variabler

NoRGast består av to skjemaer. Et operasjonsskjema fylles ut i forbindelse med operasjonen og et oppfølgingsskjema fylles ut 30 dager etter. Det meste av variabler som brukes i denne pakken kommer direkte fra innregistreringen, men noen få endres eller defineres i pakken. Dette skjer i all hovedsak i funksjonen NorgastPreprosess. OBS! MÅ OPPDATERES ETTER ENDRING AV VARIABELNAVN PÅ STAGING.

Følgende variabler endres/defineres i pakken:

* `erMann` - Navneendring fra `ErMann` for konsistens med andre register
* `Alder` - Navneendring fra `PasientAlder`
* `OperasjonsDato` - Operasjonsdato i R datoformat basert på `OPERATION_DATE`
* `Mnd` - Måned for operasjon (1 til 12) fra `OperasjonsDato`
* `Aar` - År for operasjon (2014-) fra `OperasjonsDato`
* `DoedsDato` - Dødsdato i R datoformat basert på `DECEASED_DATE`
* `OpDoedTid` - Tid fra operasjon til død i dager, differanse mellom `DoedsDato` og `OperasjonsDato`
* `SykehusNavn` - Kopi av `Sykehusnavn` (Burde gjøres som navneendring eller fjernes helt)
* `NCSP` - Renskes opp i ved at alle gjøres om til store bokstaver og gis forklaring der mulig
* `Vektendring` - Motsatt fortegn til `WEIGHTLOSS`
* `Forbehandling` - Neoadjuvant behandling, sammensatt variabel basert på `CHEMOTHERAPY_ONLY`, `RADIATION_THERAPY_ONLY` og `CHEMORADIOTHERAPY`.
* `BMI_kodet` - Variabel med tekstetikettene til `BMI_CATEGORY`
* `Operasjonsgrupper` - De primære operasjonsgruppene i registeret som definert gjennom ncsp-kodene:
    + Kolonreseksjoner - jfh* + jfb20-64
    + Rektumreseksjoner - jgb*
    + Øsofagusreseksjoner - jcc*
    + Ventrikkelreseksjoner - jdc* og jdd*
    + Leverreseksjoner - jjb*
    + Whipples operasjon - jlc30 og jlc31
    + Cholecystektomi - jka20 og jka21
    + Appendektomi - jea00 og jea01
    + Tynntarmsreseksjon - jfb00 og jfb01
    + Gastric bypass - jdf10 og jdf11
    + Gastric sleeve - jdf96 og jdf97
* `Op_gr` - Kodet versjon av `Operasjonsgrupper`
    + 1: Kolonreseksjoner
    + 2: Rektumreseksjoner
    + 3: Øsofagusreseksjoner
    + 4: Ventrikkelreseksjoner
    + 5: Leverreseksjoner
    + 6: Whipples operasjon
    + 7: Cholecystektomi
    + 8: Appendektomi
    + 9: Tynntarmsreseksjon
    + 10: Gastric bypass
    + 11: Gastric sleeve
    + 99: Annet
* `Op_gr2` - Alternativ gruppering av operasjonene til bruk i samlerapport
    + 1: Kolonreseksjoner, ny anastomose
    + 2: Kolonreseksjoner, øvrige
    + 3: Rektumreseksjoner, ny anastomose
    + 4: Rektumreseksjoner, øvrige
    + 5: Øsofagusreseksjoner
    + 6: Ventrikkelreseksjoner, ny anastomose
    + 7: Ventrikkelreseksjoner, øvrige
    + 8: Whipples operasjon
    + 9: Annet
* `AccordionGrad` - `AccordionGrad` og `OppfAccordionGrad` gjøres numerisk og kategorien 'Mindre enn 3' settes lik 1. Settes så lik maksimum av de to.
* `ReLapNarkose` - Settes lik 1 hvis `ReLapNarkose` eller `OppfReLapNarkose` er lik 1.
* `ViktigsteFunn` - Settes til minimum av `ViktigsteFunn` og `OppfViktigsteFunn`, dvs. den mest alvorlige komplikasjonen.
* `Hastegrad` - Elektiv eller ø-hjelp, basert på når operasjonen fant sted
    + 1: Elektiv - Operasjon 8-16 på en vanlig arbeidsdag (ikke helg eller off. helligdag)
    + 0: Ø-hjelp - Operasjon uten vanlig arbeidstid
* `AvlastendeStomiRektum` - 
* `` - 
* `` - 

## Funksjoner

### NorgastFigAndelTid

Denne funksjonen lager en tidstrend av rate/andel for en gitt variabel. Funksjonen kan lage noe forskjelige figurtyper avhengig av brukervalgene.

```{r, include=FALSE, echo = FALSE}
library(norgast)
RegData <- read.table('C:/SVN/jasper/norgast/data/AlleVariablerNum2016-08-16 09-59-09.txt', header=TRUE, 
                      sep=";", encoding = 'UFT-8')
ForlopData <- read.table('C:/SVN/jasper/norgast/data/ForlopsOversikt2016-08-16 09-59-13.txt', 
                         header=TRUE, sep=";", encoding = 'UFT-8')
RegData <- RegData[,c('ForlopsID','BMIKategori','VekttapProsent','MedDiabetes','KunCytostatika',
                      'KunStraaleterapi','KjemoRadioKombo','WHOECOG',
                      'ModGlasgowScore','ASA','AnestesiStartKl','Hovedoperasjon','OpDato',
                      'NyAnastomose','NyStomi','Tilgang','Robotassistanse','ThoraxTilgang',
                      'ReLapNarkose','ViktigsteFunn','AccordionGrad', 'PRSScore','RegistreringStatus', 
                      'OppfStatus', 'OppfAccordionGrad','OppfReLapNarkose', 
                      'OppfViktigsteFunn', 'Avdod', 'AvdodDato')]
ForlopData <- ForlopData[,c('ErMann', 'AvdRESH', 'Sykehusnavn', 'PasientAlder', 'HovedDato', 
                            'BasisRegStatus', 'ForlopsID', 'PasientID')]
RegData <- merge(RegData, ForlopData, by.x = "ForlopsID", by.y = "ForlopsID")
NorgastFigAndelTid(RegData=RegData, valgtVar='ReLapNarkose', reshID=601225, preprosess=T, 
                   outfile = 'MndMKonf.png', tidsenhet='Mnd')
NorgastFigAndelTid(RegData=RegData, valgtVar='ReLapNarkose', reshID=601225, preprosess=T, 
                   outfile = 'MndUKonf.png', tidsenhet='Mnd', inkl_konf = F)

```
<img src="MndMKonf.png" alt="Drawing" style="width: 300px;"/>
<img src="MndUKonf.png" alt="Drawing" style="width: 300px;"/>

Note the various macros within the `vignette` section of the metadata block above. These are required in order to instruct R how to build the vignette. Note that you should change the `title` field and the `\VignetteIndexEntry` to match the title of your vignette.

## Styles

The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows:

    output: 
      rmarkdown::html_vignette:
        css: mystyles.css

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side. 

```{r, fig.show='hold'}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))
